function newElevStateHandler(a){a.handleNewState()}function Elevator(c,d,b,a){newGuard(this,Elevator);Movable.call(this);var e=this;e.ACCELERATION=b*2.1;e.DECELERATION=b*2.6;e.MAXSPEED=b*c;e.floorCount=d;e.floorHeight=b;e.maxUsers=a||4;e.destinationY=0;e.velocityY=0;e.isMoving=false;e.goingDownIndicator=true;e.goingUpIndicator=true;e.currentFloor=0;e.nextCleanlyStoppableFloor=0;e.buttonStates=_.map(_.range(d),function(g,f){return false});e.moveCount=0;e.removed=false;e.userSlots=_.map(_.range(e.maxUsers),function(f,g){return{pos:[2+(g*10),30],user:null}});e.width=e.maxUsers*10;e.destinationY=e.getYPosOfFloor(e.currentFloor);e.on("new_state",newElevStateHandler);e.on("change:goingUpIndicator",function(f){e.trigger("indicatorstate_change",{up:e.goingUpIndicator,down:e.goingDownIndicator})});e.on("change:goingDownIndicator",function(f){e.trigger("indicatorstate_change",{up:e.goingUpIndicator,down:e.goingDownIndicator})})}Elevator.prototype=Object.create(Movable.prototype);Elevator.prototype.setFloorPosition=function(b){var a=this.getYPosOfFloor(b);this.currentFloor=b;this.moveTo(null,a)};Elevator.prototype.userEntering=function(a){var c=_.random(this.userSlots.length-1);for(var b=0;b<this.userSlots.length;b++){var d=this.userSlots[(b+c)%this.userSlots.length];if(d.user===null){d.user=a;return d.pos}}return false};Elevator.prototype.pressFloorButton=function(b){var a;b=limitNumber(b,0,this.floorCount-1);a=this.buttonStates[b];this.buttonStates[b]=true;if(!a){this.trigger("floor_button_pressed",b);this.trigger("floor_buttons_changed",this.buttonStates,b)}};Elevator.prototype.userExiting=function(a){for(var b=0;b<this.userSlots.length;b++){var c=this.userSlots[b];if(c.user===a){c.user=null}}};Elevator.prototype.updateElevatorMovement=function(f){if(this.isBusy()){return}this.velocityY=limitNumber(this.velocityY,-this.MAXSPEED,this.MAXSPEED);this.moveTo(null,this.y+this.velocityY*f);var c=this.destinationY-this.y;var b=Math.sign(c);var h=Math.sign(this.velocityY);var e=+0;if(c!==0){if(b===h){var a=distanceNeededToAchieveSpeed(this.velocityY,0,this.DECELERATION);if(a*1.05<-Math.abs(c)){var g=accelerationNeededToAchieveChangeDistance(this.velocityY,0,c);var d=Math.min(this.DECELERATION*1.1,Math.abs(g));this.velocityY-=b*d*f}else{e=Math.min(Math.abs(c*5),this.ACCELERATION);this.velocityY+=b*e*f}}else{if(h===0){e=Math.min(Math.abs(c*5),this.ACCELERATION);this.velocityY+=b*e*f}else{this.velocityY-=h*this.DECELERATION*f;if(Math.sign(this.velocityY)!==h){this.velocityY=0}}}}if(this.isMoving&&Math.abs(c)<0.5&&Math.abs(this.velocityY)<3){this.moveTo(null,this.destinationY);this.velocityY=0;this.isMoving=false;this.handleDestinationArrival()}};Elevator.prototype.handleDestinationArrival=function(){this.trigger("stopped",this.getExactCurrentFloor());if(this.isOnAFloor()){this.buttonStates[this.currentFloor]=false;this.trigger("floor_buttons_changed",this.buttonStates,this.currentFloor);this.trigger("stopped_at_floor",this.currentFloor);this.trigger("exit_available",this.currentFloor,this);this.trigger("entrance_available",this)}};Elevator.prototype.goToFloor=function(a){this.makeSureNotBusy();this.isMoving=true;this.destinationY=this.getYPosOfFloor(a)};Elevator.prototype.getFirstPressedFloor=function(){deprecationWarning("getFirstPressedFloor");for(var a=0;a<this.buttonStates.length;a++){if(this.buttonStates[a]){return a}}return 0};Elevator.prototype.getPressedFloors=function(){for(var b=0,a=[];b<this.buttonStates.length;b++){if(this.buttonStates[b]){a.push(b)}}return a};Elevator.prototype.isSuitableForTravelBetween=function(b,a){if(b>a){return this.goingDownIndicator}if(b<a){return this.goingUpIndicator}return true};Elevator.prototype.getYPosOfFloor=function(a){return(this.floorCount-1)*this.floorHeight-a*this.floorHeight};Elevator.prototype.getExactFloorOfYPos=function(a){return((this.floorCount-1)*this.floorHeight-a)/this.floorHeight};Elevator.prototype.getExactCurrentFloor=function(){return this.getExactFloorOfYPos(this.y)};Elevator.prototype.getDestinationFloor=function(){return this.getExactFloorOfYPos(this.destinationY)};Elevator.prototype.getRoundedCurrentFloor=function(){return Math.round(this.getExactCurrentFloor())};Elevator.prototype.getExactFutureFloorIfStopped=function(){var a=distanceNeededToAchieveSpeed(this.velocityY,0,this.DECELERATION);return this.getExactFloorOfYPos(this.y-Math.sign(this.velocityY)*a)};Elevator.prototype.isOnAFloor=function(){return epsilonEquals(this.getExactCurrentFloor(),this.getRoundedCurrentFloor())};Elevator.prototype.getLoadFactor=function(){var a=_.reduce(this.userSlots,function(b,c){return b+(c.user?c.user.weight:0)},0);return a/(this.maxUsers*100)};Elevator.prototype.isFull=function(){for(var a=0;a<this.userSlots.length;a++){if(this.userSlots[a].user===null){return false}}return true};Elevator.prototype.isEmpty=function(){for(var a=0;a<this.userSlots.length;a++){if(this.userSlots[a].user!==null){return false}}return true};Elevator.prototype.handleNewState=function(){var d=this.getRoundedCurrentFloor();if(d!==this.currentFloor){this.moveCount++;this.currentFloor=d;this.trigger("new_current_floor",this.currentFloor)}if(this.velocityY!==0){var b=this.getExactFutureFloorIfStopped();b=(this.velocityY>0?Math.floor:Math.ceil)(b);if(this.nextCleanlyStoppableFloor!==b){var c=this.getDestinationFloor();if(c!==this.nextCleanlyStoppableFloor){var a=Math.sign(this.velocityY)===Math.sign(this.getYPosOfFloor(this.nextCleanlyStoppableFloor)-this.y);if(a){var e=this.velocityY>0?"down":"up";this.trigger("passing_floor",this.nextCleanlyStoppableFloor,e)}if(this.getDestinationFloor()!==this.nextCleanlyStoppableFloor){this.nextCleanlyStoppableFloor=b}}}}};